<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<META http-equiv="X-UA-Compatible" content="IE=8">
<TITLE>Drawing Page</TITLE>
<script src="js/jhtml2canvas.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="bootstrap.min.css"/>
<script src="js/socket.io.min.js"></script>
</HEAD>
<style>
	.page_drop{
		position: fixed;
		width: 100%;
		height: 100%;
		top:0px;
		background: #DDD;
		left: 0px;		
	}

	.page_drop .title{
		padding:10px;;
		color: #000;
		text-align:center;
	}
	.page_drop #drawingBoard{
		width: 100%;
		height: 80%;
		background: #ffffff;
		border: 1px solid #AAA;
    margin: 0px auto;
	}
  .connectWrapper{
    position: relative;
    margin-top: 25%
  }
</style>
<BODY>
<div class="container">
  <div class="page_drop" style="display:none" id="page_drop">
  	<div class="title"> <h1 id="connectorName"></h1> </div>
  	<div id="drawingBoard"></div>
      <div class="row ">
        <div class="col-sm-2 col-sm-offset-3 form-group">
          <select class="form-control" onchange="drawingBoard.setColor(this.value)" id="_colorPicker">
          </select>
        </div>
        <div class="col-sm-1 form-group">
          <select class="form-control" onchange="drawingBoard.setPenSize(this.value)" id="_sizePicker">
          </select>
      </div>
      <div class="col-sm-4">
        <button class="btn btn-default" onclick="drawingBoard.setColor('white')">Erase</button>
        <button class="btn btn-default" onclick="drawingBoard.erase()">Clear Board</button>
        <button class="btn btn-default" onclick="refresh()">Refresh</button>
      </div>
    </div>
  </div>

  <div class="connectWrapper" id="connectWrapper">
    <div class="row">
      <div class="col-sm-4 col-sm-offset-4 form-group">
        <input id="IP" placeholder="Please Enter Socket IP" class="form-control">
      </div>
      <div class="col-sm-4 col-sm-offset-4 form-group">
        <input id="userName" placeholder="UserName" class="form-control">
      </div>
      <div class="col-sm-4 col-sm-offset-4">
        <input type="button" id="start" onclick="connectUser()" class="btn btn-primary form-control col-sm-12" placeholder="Please Enter Socket Host" value="Connect">
      </div>
    </div>
  </div>
</div>
<script>

    var connectorName,
        connectWrapper,
        ip,
        canvasPage,
        userName,
        dropZone,
        _colorPicker,
        _sizePicker,
        drawingBoard,
        deviceInfo;

function cordoVaInitializer(){
    connectorName = document.getElementById('connectorName');
    connectWrapper = document.getElementById('connectWrapper');
      ip = document.getElementById('IP');
      canvasPage = document.getElementById('page_drop');
      userName = document.getElementById('userName');
      dropZone = document.getElementById("drawingBoard");
      _colorPicker = document.getElementById("_colorPicker");
      _sizePicker = document.getElementById("_sizePicker");

      deviceInfo = {
        id: "_childView:"+ +new Date
      };


    if(sessionStorage.IP && sessionStorage.userName){
      init(sessionStorage.IP,sessionStorage.userName)
    }
}



function connectUser(){
  if(ip.value && userName.value){
    init(ip.value, userName.value);
    // store our session
    sessionStorage.IP = ip.value;
    sessionStorage.userName = userName.value;
  }
}

function init(ip, uName){
  connectorName.innerHTML = uName;
  connectWrapper.style.display = "none";
  canvasPage.style.display = "block";

  deviceInfo.name = uName;
  start(ip);
}

function start(ip){
    var socket = io.connect(ip);
    // set the canvas size
      deviceInfo.height =  dropZone.clientHeight;
      deviceInfo.width = dropZone.clientWidth;

    drawingBoard = new jHTML2Canvas().drawing(deviceInfo,dropZone);
    // broadcast
    socket.emit('device.role',{
      isAdmin: false
    });
    
    drawingBoard.init(function(){
      buildColorPicker(drawingBoard.colors, _colorPicker);
      buildColorPicker(drawingBoard.size, _sizePicker);
      var interaction = drawingBoard.interact();
        interaction.socketEnabled = true;
        interaction.socket = socket;
        // interaction.ajax.post.url = 'http://localhost/events/index.php';
        // interaction.ajax.get.url = 'http://localhost/events';
        interaction
          .connect()
          .watch();

        interaction.$on('redraw.client', function(obj){
          drawingBoard.reScale(obj);
          dropZone.style.width = obj.stack.width + "px";
          dropZone.style.height = obj.stack.height + "px";
        });
    });

}

function buildColorPicker(list, _pickerZone){
  var option = "";
  list.forEach(function(color){
    option +='<option value="'+color+'" style="background:'+color+'" '+((color==='black')?'selected="true"':"")+'>'+color+'</option>';
  });
  _pickerZone.innerHTML = option;
  option = "";
}


function refresh(){
  history.go();
}

document.addEventListener('deviceready', cordoVaInitializer, false);
cordoVaInitializer();

</script>

<!-- <script type="text/javascript" src="cordova.js"></script> -->
</BODY>
</HTML>
